<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MBTI Match - Dashboard</title>
    <link rel="stylesheet" href="static/css/sanitize.css">
    <link rel="stylesheet" href="static/css/login.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background-image: url("static/img/paw.png");
          background-repeat: repeat;
          background-size: 80px 80px;
          opacity: 0.05;
          transform: rotate(-30deg);
          z-index: 0;
          pointer-events: none;
        }
      </style>
</head>
<body>
    <button id="logout-btn" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <button id="delete-account-btn" class="delete-button">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
    <div id="loading-overlay" class="hidden">
        <div class="loading-box">
          <div class="spinner"></div>
          <img src="static/img/bear_3.png" alt="ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãã¾" class="bear-loader">
          <p class="loading-text">ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>
    </div>


    <div class="intro-animation">
        <img src="static/img/bear_1.png" alt="Bear" class="bear-animation">
        <div class="speech-bubble">ãƒãƒƒãƒã—ã¦ãƒªã‚¹ãƒˆã‹ã‚‰<br>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼</div>
    </div>


    <div class="container">
        <!-- <h1>MBTI Match </h1> -->
        <button id="bearspage-btn" class="btn">MBTIã„ã¡ã‚‰ã‚“</button>

        <div class="user-info">
            <!-- <p id="subscribe-type" class="subscribe-type">subscribe-type</p> -->
            <p id="user-name" class="user-name">User</p>
            <div class="user-mbti-container">
                <img id="user-icon" class="user-icon" src="" alt="User Icon">
                <div class="mbti-block">
                    <span id="user-mbti" class="user-mbti">MBTI</span>
                    <span id="user-mbti-desc" class="user-mbti-desc">æ—¥æœ¬èªå</span>
                </div>
            </div>
        </div>
        
        <button id="match-btn" class="btn">ãƒãƒƒãƒãƒ³ã‚°</button>
        <div id="match-animation" class="hidden" style="display: none;">
            <div class="bear-row">
              <img id="left-bear" class="bear-img bear-left" src="" />
              <img id="right-bear" class="bear-img bear-right" src="" />
            </div>
            <div id="encounter-text" class="encounter-text">â—â—ã•ã‚“ã¨é­é‡ã—ã¾ã—ãŸï¼</div>
        </div>
        <button id="match_list_reload" class="btn">
        <span id="message-notification" class="unread-indicator hidden"></span>
        ãƒãƒƒãƒãƒªã‚¹ãƒˆ
        </button>
        <ul id="matched-user" class="match-list"></ul>
        <!-- <button id="subscribe-btn" class="btn">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</button> -->
        <button id="minigame-btn" class="btn">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </button>
        <button id="contact-btn" class="btn">å•ã„åˆã‚ã›</button>
    </div>

    <div id="delete-modal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="delete-title">
        <div class="modal-card" role="document">
            <h3 id="delete-title" class="modal-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ç¢ºèª</h3>
            <p class="modal-desc">
            ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚„ãƒãƒƒãƒæƒ…å ±ã‚‚åˆ©ç”¨ã§ããªããªã‚Šã¾ã™ã€‚
            </p>

            <label class="modal-agree">
            <input id="delete-confirm" type="checkbox" />
            <span>å†…å®¹ã«åŒæ„ã—ã¦å‰Šé™¤ã—ã¾ã™ã€‚</span>
            </label>

            <div class="modal-actions">
            <button id="delete-cancel" type="button" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="delete-ok" type="button" class="btn-danger">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- <button id="test-match-animation">ğŸ‰ ãƒãƒƒãƒãƒ³ã‚°æ¼”å‡ºãƒ†ã‚¹ãƒˆ</button> -->

    <script src="static/js/login.js" defer></script>

    <!-- <script>
        (() => {
        if (window.__deleteInline) return; window.__deleteInline = true; // â˜…äºŒé‡é˜²æ­¢
        const btn    = document.getElementById('delete-account-btn');
        const modal  = document.getElementById('delete-modal');
        const ok     = document.getElementById('delete-ok');
        const cancel = document.getElementById('delete-cancel');
        const agree  = document.getElementById('delete-confirm');
        const API_BASE = location.hostname.endsWith('github.io')
            ? 'https://bearhug-6c58c8d5bd0e.herokuapp.com'  // â˜…æœ¬ç•ª(ä¾‹)
            : 'http://localhost:5000';                       // â˜…ãƒ­ãƒ¼ã‚«ãƒ«(ä¾‹)

        const getUid = () => {
            const s = sessionStorage.getItem('user_id') ?? new URLSearchParams(location.search).get('user_id') ?? '';
            const id = parseInt(s, 10);
            console.log('[inline] user_id:', s, '->', id);   // â˜…ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            return id;
        };

        const open  = () => { if (modal)  modal.classList.remove('hidden'); };
        const close = () => { if (modal)  modal.classList.add('hidden'); };

        if (btn) {
            btn.addEventListener('click', () => {
            console.log('[inline] delete button clicked'); // â˜…ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            if (modal && ok && cancel && agree) {
                open();
            } else {
                const uid = getUid();
                if (!Number.isFinite(uid)) return alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚');
                if (confirm('æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) doDelete(uid);
            }
            });
        }

        if (cancel) cancel.addEventListener('click', () => { console.log('[inline] cancel'); close(); });
        if (ok) ok.addEventListener('click', () => {
            if (!agree.checked) return alert('åŒæ„ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚');
            const uid = getUid();
            if (!Number.isFinite(uid)) return alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚');
            doDelete(uid);
        });

        async function doDelete(uid){
            console.log('[inline] POST', `${API_BASE}/auth/account/delete`, {user_id: uid}); // â˜…ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            try{
            const r = await fetch(`${API_BASE}/auth/account/delete`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body: JSON.stringify({user_id: uid, confirm: true})
            });
            const txt = await r.text();
            console.log('[inline] status', r.status, 'raw', txt); // â˜…ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            if (!r.ok) return alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
            try { sessionStorage.clear(); } catch(e){}
            try { localStorage.removeItem('user_id'); } catch(e){}
            const base = location.hostname.endsWith('github.io') ? '/bearhug-frontend-hosting/' : '/';
            location.href = base + 'login';
            } catch(e){
            console.error('[inline] fetch error', e);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            } finally {
            close();
            }
        }
        })();
    </script> -->

    <!-- <iframe id="bgm-iframe" src="static/sound/bgm.html" style="display:none;"></iframe>
    <script>
    const bgmFrame = document.getElementById("bgm-iframe");
    document.addEventListener("click", () => {
        bgmFrame.contentWindow.postMessage({ command: "play" }, "*");
    }, { once: true });
    </script> -->
</body>
</html>
