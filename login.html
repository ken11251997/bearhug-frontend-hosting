<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MBTI Match - Dashboard</title>
    <link rel="stylesheet" href="static/css/sanitize.css">
    <link rel="stylesheet" href="static/css/login.css">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background-image: url("static/img/paw.png");
          background-repeat: repeat;
          background-size: 80px 80px;
          opacity: 0.05;
          transform: rotate(-30deg);
          z-index: 0;
          pointer-events: none;
        }
      </style>
</head>
<body>
    <button id="logout-btn" class="logout-button">ログアウト</button>
    <button id="delete-account-btn" class="delete-button">アカウント削除</button>
    <div id="loading-overlay" class="hidden">
        <div class="loading-box">
          <div class="spinner"></div>
          <img src="static/img/bear_3.png" alt="ローディングくま" class="bear-loader">
          <p class="loading-text">ロード中...</p>
        </div>
    </div>


    <div class="intro-animation">
        <img src="static/img/bear_1.png" alt="Bear" class="bear-animation">
        <div class="speech-bubble">マッチしてリストから<br>メッセージ！</div>
    </div>


    <div class="container">
        <!-- <h1>MBTI Match </h1> -->
        <button id="bearspage-btn" class="btn">MBTIいちらん</button>

        <div class="user-info">
            <!-- <p id="subscribe-type" class="subscribe-type">subscribe-type</p> -->
            <p id="user-name" class="user-name">User</p>
            <div class="user-mbti-container">
                <img id="user-icon" class="user-icon" src="" alt="User Icon">
                <div class="mbti-block">
                    <span id="user-mbti" class="user-mbti">MBTI</span>
                    <span id="user-mbti-desc" class="user-mbti-desc">日本語名</span>
                </div>
            </div>
        </div>
        
        <button id="match-btn" class="btn">マッチング</button>
        <div id="match-animation" class="hidden" style="display: none;">
            <div class="bear-row">
              <img id="left-bear" class="bear-img bear-left" src="" />
              <img id="right-bear" class="bear-img bear-right" src="" />
            </div>
            <div id="encounter-text" class="encounter-text">●●さんと遭遇しました！</div>
        </div>
        <button id="match_list_reload" class="btn">
        <span id="message-notification" class="unread-indicator hidden"></span>
        マッチリスト
        </button>
        <ul id="matched-user" class="match-list"></ul>
        <!-- <button id="subscribe-btn" class="btn">アップグレード</button> -->
        <button id="minigame-btn" class="btn">ミニゲーム</button>
        <button id="contact-btn" class="btn">問い合わせ</button>
    </div>

    <div id="delete-modal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="delete-title">
        <div class="modal-card" role="document">
            <h3 id="delete-title" class="modal-title">アカウント削除の確認</h3>
            <p class="modal-desc">
            この操作は取り消せません。チャット履歴やマッチ情報も利用できなくなります。
            </p>

            <label class="modal-agree">
            <input id="delete-confirm" type="checkbox" />
            <span>内容に同意して削除します。</span>
            </label>

            <div class="modal-actions">
            <button id="delete-cancel" type="button" class="btn-cancel">キャンセル</button>
            <button id="delete-ok" type="button" class="btn-danger">削除する</button>
            </div>
        </div>
    </div>

    <!-- <button id="test-match-animation">🎉 マッチング演出テスト</button> -->

    <script src="static/js/login.js" defer></script>

    <!-- <script>
        (() => {
        if (window.__deleteInline) return; window.__deleteInline = true; // ★二重防止
        const btn    = document.getElementById('delete-account-btn');
        const modal  = document.getElementById('delete-modal');
        const ok     = document.getElementById('delete-ok');
        const cancel = document.getElementById('delete-cancel');
        const agree  = document.getElementById('delete-confirm');
        const API_BASE = location.hostname.endsWith('github.io')
            ? 'https://bearhug-6c58c8d5bd0e.herokuapp.com'  // ★本番(例)
            : 'http://localhost:5000';                       // ★ローカル(例)

        const getUid = () => {
            const s = sessionStorage.getItem('user_id') ?? new URLSearchParams(location.search).get('user_id') ?? '';
            const id = parseInt(s, 10);
            console.log('[inline] user_id:', s, '->', id);   // ★デバッグログ
            return id;
        };

        const open  = () => { if (modal)  modal.classList.remove('hidden'); };
        const close = () => { if (modal)  modal.classList.add('hidden'); };

        if (btn) {
            btn.addEventListener('click', () => {
            console.log('[inline] delete button clicked'); // ★デバッグログ
            if (modal && ok && cancel && agree) {
                open();
            } else {
                const uid = getUid();
                if (!Number.isFinite(uid)) return alert('ユーザー情報が取得できません。');
                if (confirm('本当にアカウントを削除しますか？この操作は取り消せません。')) doDelete(uid);
            }
            });
        }

        if (cancel) cancel.addEventListener('click', () => { console.log('[inline] cancel'); close(); });
        if (ok) ok.addEventListener('click', () => {
            if (!agree.checked) return alert('同意チェックを入れてください。');
            const uid = getUid();
            if (!Number.isFinite(uid)) return alert('ユーザー情報が取得できません。');
            doDelete(uid);
        });

        async function doDelete(uid){
            console.log('[inline] POST', `${API_BASE}/auth/account/delete`, {user_id: uid}); // ★デバッグログ
            try{
            const r = await fetch(`${API_BASE}/auth/account/delete`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body: JSON.stringify({user_id: uid, confirm: true})
            });
            const txt = await r.text();
            console.log('[inline] status', r.status, 'raw', txt); // ★デバッグログ
            if (!r.ok) return alert('削除に失敗しました。時間をおいて再試行してください。');
            try { sessionStorage.clear(); } catch(e){}
            try { localStorage.removeItem('user_id'); } catch(e){}
            const base = location.hostname.endsWith('github.io') ? '/bearhug-frontend-hosting/' : '/';
            location.href = base + 'login';
            } catch(e){
            console.error('[inline] fetch error', e);
            alert('通信エラーが発生しました。');
            } finally {
            close();
            }
        }
        })();
    </script> -->

    <!-- <iframe id="bgm-iframe" src="static/sound/bgm.html" style="display:none;"></iframe>
    <script>
    const bgmFrame = document.getElementById("bgm-iframe");
    document.addEventListener("click", () => {
        bgmFrame.contentWindow.postMessage({ command: "play" }, "*");
    }, { once: true });
    </script> -->
</body>
</html>
