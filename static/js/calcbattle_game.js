
document.addEventListener("DOMContentLoaded", () => {

  // const loadingOverlay = document.getElementById("loading-overlay");
  // if (loadingOverlay) {
  //   loadingOverlay.classList.add("hidden");
  //   loadingOverlay.style.display = "none";
  // }
  const loadingOverlay = document.getElementById("loading-overlay");
  if (loadingOverlay) {
    loadingOverlay.classList.add("hidden");
    loadingOverlay.style.display = "none";
    console.log("‚úÖ ÂàùÊúü„Å´„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÊ∂à„Åó„Åæ„Åó„Åü");
  }

  alert("a")
  
  

  const successSound = new Audio("static/sound/success.mp3");
  const failSound = new Audio("static/sound/fail.mp3");
  const decisionSound = new Audio("static/sound/decision.mp3");

  const startScreen = document.getElementById("start-screen");
  const gameScreen = document.getElementById("game-screen");
  const endScreen = document.getElementById("end-screen");

  const startBtn = document.getElementById("start-btn");
  const retryBtn = document.getElementById("retry-btn");
  const backBtn = document.getElementById("back-btn");
  const rankingBtn = document.getElementById("ranking-btn");
  const rankingAgainBtn = document.getElementById("ranking-again-btn"); // ‚úÖ HTML„Å®‰∏ÄËá¥„Åï„Åõ„Çã
  const rankingBtns = document.querySelectorAll("#ranking-btn, #ranking-again-btn");

  const timerDisplay = document.getElementById("timer");
  const feedbackDisplay = document.getElementById("feedback");
  const finalTimeDisplay = document.getElementById("final-time");

  const user_id = new URLSearchParams(window.location.search).get("user_id");
  const mbti = new URLSearchParams(window.location.search).get("mbti");

  const bgImage = new Image();
  bgImage.src = "static/img/calc.jpg";  // „ÅÇ„Å™„Åü„ÅÆËÉåÊôØÁîªÂÉè„ÅÆ„Éë„Çπ„Å´Âêà„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ

  bgImage.onload = () => {
    loadingOverlay.style.display = "none";
    console.log("‚úÖ ËÉåÊôØÁîªÂÉè„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");
  };

  bgImage.onerror = () => {
    loadingOverlay.style.display = "none";
    console.warn("‚ö†Ô∏è ËÉåÊôØÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó");
  };


  document.getElementById("back-button").onclick = () => {
    location.href = "minigame_list.html";
  };

  let currentQuestionIndex = 0;
  let startTime = 0;
  let elapsed = 0;
  let penaltyTime = 0;
  let timerInterval = null;
  const totalQuestions = 5;
  let questions = [];

  function generateQuestions() {
    const q = [];
    for (let i = 0; i < totalQuestions; i++) {
      const a = Math.floor(Math.random() * 20) + 1;
      const b = Math.floor(Math.random() * 20) + 1;
      const ops = ['+', '-', '√ó'];
      const op = ops[Math.floor(Math.random() * ops.length)];
      let answer, questionText;

      switch (op) {
        case '+':
          answer = a + b;
          questionText = `${a} + ${b} = ?`;
          break;
        case '-':
          answer = a - b;
          questionText = `${a} - ${b} = ?`;
          break;
        case '√ó':
          answer = a * b;
          questionText = `${a} √ó ${b} = ?`;
          break;
      }

      const choices = new Set();
      choices.add(answer);
      while (choices.size < 4) {
        choices.add(answer + Math.floor(Math.random() * 10) - 5);
      }

      q.push({
        questionText,
        answer,
        choices: Array.from(choices).sort(() => Math.random() - 0.5),
      });
    }
    return q;
  }


  function showScreen(target) {
    [startScreen, gameScreen, endScreen].forEach(screen => {
      screen.classList.add("hidden");
      screen.classList.remove("active"); // ‚Üê ÂøÖÈ†à
    });
    target.classList.remove("hidden");
    target.classList.add("active");      // ‚Üê ÂøÖÈ†à
    console.log("üé¨ Ë°®Á§∫ÁîªÈù¢:", target.id);
  }


  startBtn.addEventListener("click", () => {
    // const bgmWin = window.open('', 'bgmWindow'); // „Åô„Åß„Å´Â≠òÂú®„Åó„Å¶„ÅÑ„Çå„Å∞ÂèÇÁÖß„Åï„Çå„Çã
    // if (bgmWin && !bgmWin.closed) {
    //   bgmWin.close();
    // }

    // ‚úÖ „Éç„Ç§„ÉÜ„Ç£„Éñ„Å´BGMÂàáÊõø„Çí‰æùÈ†ºÔºàmode: "calc"Ôºâ
    if (window.ReactNativeWebView) {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: "SWITCH_BGM",
        mode: "calc"
      }));
    }

    startBtn.disabled = true;

    if (!user_id) {
      console.warn("‚ö†Ô∏è user_id „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÈñãÂßã„Åó„Åæ„Åô„ÄÇ");
      beginGameFlow();  // ‚Üê „É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÇÇÈñãÂßã
      return;
    }

    fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/game/play_start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id })
    })
        .then(async res => {
        if (res.status === 429) {
            // alert("ÁÑ°Êñô„Éó„É¨„Ç§ÂõûÊï∞„Åå‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ\nÂ∫ÉÂëä„ÇíË¶ã„Çã„Å®Á∂öË°å„Åß„Åç„Åæ„Åô„ÄÇ");
            showPopup("Â∫ÉÂëä„ÇíË¶ã„Å¶\n„ÅÇ„Åù„Å∂!", () => {
              openLoadingOverlay("üé¨ Â∫ÉÂëäË™≠„ÅøËæº„Åø‰∏≠‚Ä¶");
              onWatchAd("game");
                    });
            // onWatchAd("game"); 
            return;
        }
        const data = await res.json();
        if (data.show_ad) {
            onWatchAd("game");
        } else {
            beginGameFlow();
        }
        })
        .catch(err => {
        console.error("ÈÄö‰ø°„Ç®„É©„Éº:", err);
        // alert("ÈÄö‰ø°„Ç®„É©„Éº:")
        });
    });

  // function beginGameFlow() {
  //   console.log("‚ñ∂Ô∏è beginGameFlow ÂÆüË°å");
  //   document.getElementById("start-screen").classList.add("hidden");
  //   document.getElementById("end-screen").classList.add("hidden");
  //   document.getElementById("game-screen").classList.remove("hidden");

  //   questions = generateQuestions();
  //   console.log("üéØ ÁîüÊàê„Åï„Çå„ÅüÂïèÈ°åÔºö", questions);
  //   currentQuestionIndex = 0;
  //   penaltyTime = 0;
  //   startTime = performance.now();
  //   startTimer();
  //   showQuestion();
  // }

  function beginGameFlow() {
    console.log("‚ñ∂Ô∏è beginGameFlow ÂÆüË°å");
    showScreen(gameScreen); // ‚Üê ‰øÆÊ≠£ÔºÅÁîªÈù¢Âàá„ÇäÊõø„Åà„ÅØ„Åì„ÅÆÈñ¢Êï∞„ÅßÁµ±‰∏Ä
    questions = generateQuestions();
    console.log("üéØ ÁîüÊàê„Åï„Çå„ÅüÂïèÈ°åÔºö", questions);
    currentQuestionIndex = 0;
    penaltyTime = 0;
    startTime = performance.now();
    startTimer();
    showQuestion();  // ‚Üê „Åì„Åì„ÅßË°®Á§∫
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      const now = performance.now();
      elapsed = (now - startTime) / 1000 + penaltyTime;
      timerDisplay.textContent = `„Çø„Ç§„É†: ${elapsed.toFixed(3)}Áßí`;
    }, 50);
  }

  function stopTimer() {
    clearInterval(timerInterval);
  }

  function showQuestion() {
    console.log("üì¢ showQuestion() ÈñãÂßã");

    if (questions.length === 0) {
      console.error("‚ùå ÂïèÈ°å„Åå1„Å§„ÇÇÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ");
      return;
    }

    const q = questions[currentQuestionIndex];
    console.log("‚ñ∂Ô∏è Ë°®Á§∫„Åô„ÇãÂïèÈ°å:", q);
    document.getElementById("question").textContent = q.questionText;

    const choicesContainer = document.getElementById("choices");
    choicesContainer.innerHTML = "";
    q.choices.forEach(choice => {
      const btn = document.createElement("button");
      btn.className = "choice-button";
      btn.textContent = choice;
      console.log("‚úÖ „Éú„Çø„É≥ËøΩÂä†:", btn); // ‚Üê ËøΩÂä†
      btn.addEventListener("click", () => handleAnswer(Number(choice)));
      choicesContainer.appendChild(btn);
    });
  }

  function handleAnswer(choice) {
    const q = questions[currentQuestionIndex];
    console.log("üß† „É¶„Éº„Ç∂„ÉºÂõûÁ≠î:", choice, "Ê≠£Ëß£:", q.answer);
    if (choice === q.answer) {
      successSound.play();
      console.log("‚úÖ Ê≠£Ëß£");
      showMarker("‚≠ï");  // ‚úÖ Ê≠£Ëß£„Éû„Éº„ÇØ
      currentQuestionIndex++;
      if (currentQuestionIndex >= questions.length) {
        endGame();
      } else {
        showQuestion();
      }
    } else {
      console.warn("‚ùå ‰∏çÊ≠£Ëß£ÔºÅ10ÁßíÂä†ÁÆóÔºÅ");
      failSound.play();
      showMarker("√ó");  // ‚úÖ ‰∏çÊ≠£Ëß£„Éû„Éº„ÇØ
      penaltyTime += 5;
      // ‚úÖ Ôºã5Áßí„ÅÆËµ§ÊñáÂ≠ó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
      const penaltyText = document.getElementById("penalty-text");
      penaltyText.classList.remove("hidden");
      penaltyText.classList.remove("fadePenalty"); // „É™„Çª„ÉÉ„Éà
      void penaltyText.offsetWidth; // ÂÜç„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®
      penaltyText.classList.add("penalty-text");
      setTimeout(() => {
        penaltyText.classList.add("hidden");
      }, 1000);
        }
}

  function showMarker(symbol) {
    const marker = document.getElementById("marker");
    marker.textContent = symbol;
    marker.classList.remove("hidden");
    setTimeout(() => {
      marker.classList.add("hidden");
    }, 600);
  }

  function showFeedback(text, type) {
    feedbackDisplay.textContent = text;
    feedbackDisplay.className = "feedback " + type;
    setTimeout(() => {
      feedbackDisplay.textContent = "";
      feedbackDisplay.className = "feedback";
    }, 800);
  }

  function endGame() {
    stopTimer();
    showScreen(endScreen);
    finalTimeDisplay.textContent = `Ë®òÈå≤Ôºö${elapsed.toFixed(3)}ÁßíÔºÅ`;
    

    // ‚úÖ „Çπ„Ç≥„Ç¢ÈÄÅ‰ø°Âá¶ÁêÜ
    fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/game/score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id,
        game_name: "calcbattle_game",
        score: parseFloat(elapsed.toFixed(3)),
      }),
    })
      .then(res => res.json())
      .then(data => {
        console.log("„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°ÊàêÂäü:", data);
        if (data.best !== undefined) {
            startConfetti()
          // üéâ „Åì„Åì„Åß„Ç®„Éï„Çß„ÇØ„Éà„ÇÑÈü≥„ÇíÈ≥¥„Çâ„ÅôÂá¶ÁêÜ„ÇíÂÖ•„Çå„Å¶„ÇÇOK
        }
      })
      .catch(err => {
        console.error("„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°„Ç®„É©„Éº:", err);
      });
  }

  function startConfetti() {
    const colors = ["#ffb6c1", "#ffc0cb", "#ff69b4", "#ff1493", "#db7093"];
    for (let i = 0; i < 30; i++) {
      const confetti = document.createElement("div");
      confetti.classList.add("confetti");
      confetti.style.left = Math.random() * 100 + "vw";
      confetti.style.animationDuration = (Math.random() * 2 + 2) + "s";
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }
  }

  // üéØ „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫Âá¶ÁêÜÔºà„É¢„Éº„ÉÄ„É´Ôºâ
  
  rankingBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      document.getElementById("ranking-modal").classList.remove("hidden");
      // loadRanking("mbti_median");
      loadRanking("mbti_median", "calcbattle")
    });
  });

  // üéÆ „Ç§„Éô„É≥„ÉàÁôªÈå≤
//   startBtn.addEventListener("click", startGame);
  retryBtn.addEventListener("click", beginGameFlow);
  backBtn.addEventListener("click", () => {
    showScreen(startScreen);
    openDefaultBGMWindow(); // ‚úÖ default BGM ÂÜçËµ∑Âãï
  });
//   rankingBtn.addEventListener("click", showRanking);


  function onWatchAd(type) {
    // const loadingOverlay = document.getElementById("loading-overlay");
    // loadingOverlay.classList.remove("hidden");
    // loadingOverlay.style.display = "flex";
    openLoadingOverlay("„É≠„Éº„Éâ‰∏≠‚Ä¶"); 

    if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
        type: "SHOW_REWARD_AD",
        adType: type
        }));
    } else {
        alert("üì∫ Â∫ÉÂëäÔºà‰ªÆÔºâ„ÇíË¶ã„Å¶„ÅÑ„Åæ„Åô...");
        fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, type })
        })
        .then(res => {
        if (!res.ok) throw new Error("„É™„Éü„ÉÉ„ÉàËß£Èô§Â§±Êïó");
        })
        .catch(err => {
        console.error("Â∫ÉÂëäËß£Èô§„Ç®„É©„Éº:", err);
        // alert("ÈÄö‰ø°„Ç®„É©„ÉºÔºàÂ∫ÉÂëäÔºâ: " + err.message);
        })
        .finally(() => {
        closeLoadingOverlay(); // ‚úÖ Áµ±‰∏Ä
        // alert("gameflow"); // ‚úÖ Á¢∫ÂÆü„Å´Ë°®Á§∫„Åï„Çå„Çã
        beginGameFlow();
        });
    }
    }

  // üì≤ „Ç¢„Éó„É™ÂÜÖÈÄöÁü•„Åã„ÇâÂèó„ÅëÂèñ„ÇäÔºàÂ∫ÉÂëäÂÆå‰∫ÜÔºâ
//   window.addEventListener("AD_WATCHED", (event) => {
//     const adType = event.detail?.type || "unknown";
//     fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
//       method: "POST",
//       headers: { "Content-Type": "application/json" },
//       body: JSON.stringify({ user_id, type: adType })
//     }).finally(() => {
//       const loadingOverlay = document.getElementById("loading-overlay");
//       loadingOverlay.classList.add("hidden");
//       loadingOverlay.style.display = "none";
//       beginGameFlow();
//     });
//   });

    // window.addEventListener("AD_WATCHED", (event) => {
    //   const adType = event.detail?.type || "unknown";
    //   console.log("üì© AD_WATCHED Âèó‰ø°:", adType);

    //   // ‚úÖ „Åæ„ÅöÂç≥ÊôÇ„Å´Èö†„ÅôÔºàforceRemove=falseÔºâ
    //   // closeLoadingOverlay(false);
    //   //   const el = document.getElementById("loading-overlay");
    //   // if (!el) return;
    //   // if (!el.classList.contains("hidden")) {
    //   //   el.classList.add("hidden");
    //   // }
    //   // el.style.display = "none";
    //   // console.log("‚úÖ CLOSE LoadingOverlay");

    //   // ‚è± ÈÅÖÂª∂„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºàÊèèÁîª„Çø„Ç§„Éü„É≥„Ç∞Â∑ÆÁï∞ÂØæÁ≠ñÔºâ
    //   setTimeout(() => closeLoadingOverlay(false), 150);

    //   fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
    //     method: "POST",
    //     headers: { "Content-Type": "application/json" },
    //     body: JSON.stringify({ user_id, type: adType })
    //   })
    //   .catch(err => {
    //     console.log("‚ö†Ô∏è recover API „Ç®„É©„Éº:", err);
    //   })
    //   .finally(() => {
    //     // ‚úÖ finally„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶Áï≥„Åø„Åã„Åë„Çã
    //     const el = document.getElementById("loading-overlay");
    //     if (!el) return;
    //     if (!el.classList.contains("hidden")) {
    //       el.classList.add("hidden");
    //     }
    //     el.style.display = "none";
    //     console.log("üèÅ recover ÂÆå‰∫Ü ‚Üí „Ç≤„Éº„É†ÈñãÂßã");
    //     beginGameFlow();
    //   });
    // });

    // window.addEventListener("AD_FAILED", (event) => {
    //     // alert("‚ùå AD_FAILED „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü");
    //     const msg = event.detail?.message || "‰∏çÊòé„Å™„Ç®„É©„Éº";
    //     closeLoadingOverlay();
    //     // showPopup(`‚ùå Â∫ÉÂëä„ÅÆË¶ñËÅ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${msg}`);
    // });
    


  function showPopup(message, callback) {
    // Êó¢Â≠ò„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§
    document.querySelectorAll(".popup-message").forEach(p => p.remove());
    console.log(message);

    const popup = document.createElement("div");
    popup.className = "popup-message";

    // ‚úÖ „Åì„Åì„Çí innerText ‚Üí innerHTML „Å´Â§âÊõ¥
    // ‚úÖ „Å§„ÅÑ„Åß„Å´ \n „Çí <br> „Å´Â§âÊèõÔºà"Â∫ÉÂëä„ÇíË¶ã„Å¶\n„ÅÇ„Åù„Å∂ÔºÅ" „ÇÇOKÔºâ
    popup.innerHTML = String(message).replace(/\n/g, "<br>");

    document.body.appendChild(popup);

    setTimeout(() => {
      popup.classList.add("fade-out");
      setTimeout(() => {
        popup.remove();
        if (callback) callback();
      }, 100);
    }, 750);
  }

  function openLoadingOverlay(msg) {
    const el = document.getElementById("loading-overlay");
    if (!el) { console.warn("‚ö†Ô∏è #loading-overlay „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); return; }
    // „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÜÖ„Å´„É°„ÉÉ„Çª„Éº„Ç∏Ê¨Ñ„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞Ôºà‰ªªÊÑèÔºâ
    const textEl = el.querySelector(".loading-text");
    if (textEl && msg) textEl.textContent = msg;
    el.classList.remove("hidden");
    el.style.display = "flex";
    console.log("üåÄ OPEN LoadingOverlay:", msg || "");
  }

  function closeLoadingOverlay() {
    const el = document.getElementById("loading-overlay");
    if (!el) return;
    if (!el.classList.contains("hidden")) {
      el.classList.add("hidden");
    }
    el.style.display = "none";
    console.log("‚úÖ CLOSE LoadingOverlay");
  }

  // ÈñãÂßã„Éú„Çø„É≥Âà∂Âæ°
  function enableStart() {
    if (!startBtn) return;
    startBtn.disabled = false;
    startBtn.style.pointerEvents = 'auto';
    startBtn.style.opacity = '1';
  }
// function disableStart() {
//   if (!startBtn) return;
//   startBtn.disabled = true;
//   startBtn.style.pointerEvents = 'none';
//   startBtn.style.opacity = '0.6';
// }

// ÈáçË§áÁôªÈå≤„ÇíÈÅø„Åë„Çã„Åü„ÇÅ‰∏ÄÂ∫¶ remove ‚Üí add
// window.removeEventListener('AD_WATCHED', window.__CALC_AD_WATCHED || (()=>{}));
// window.__CALC_AD_WATCHED = async (event) => {
//   // Â∫ÉÂëäÂÆå‰∫Ü ‚Üí UIÂæ©Â∏∞
//   closeLoadingOverlay();
//   enableStart();

//   // Ôºà‰ªªÊÑèÔºâ„Çµ„Éº„ÉêÂÅ¥„Åß‰∏äÈôêÂõûÊï∞„ÇíÂæ©Ê¥ª
//   try {
//     const user_id = sessionStorage.getItem('user_id');
//     const adType = event?.detail?.type || 'calcbattle';
//     if (user_id) {
//       await fetch('https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover', {
//         method: 'POST',
//         headers: { 'Content-Type': 'application/json' },
//         body: JSON.stringify({ user_id, target: adType })
//       });
//     }
//   } catch (e) { /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂ§±Êïó„ÅØÁÑ°Ë¶ñ„Åó„Å¶UI„Å†„ÅëÂæ©Â∏∞ */ }
// };
// window.addEventListener('AD_WATCHED', window.__CALC_AD_WATCHED);

// window.removeEventListener('AD_FAILED', window.__CALC_AD_FAILED || (()=>{}));
// window.__CALC_AD_FAILED = (event) => {
//   // Â∫ÉÂëäÂ§±Êïó„Åß„ÇÇÂõ∫„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜÂøÖ„ÅöÂæ©Â∏∞
//   closeLoadingOverlay();
//   enableStart();
// };
// window.addEventListener('AD_FAILED', window.__CALC_AD_FAILED);

// // „Çø„ÉñÂæ©Â∏∞ÊôÇ„ÅÆ‰øùÈô∫ÔºàÂÆüÊ©ü„ÅßÁ®Ä„Å´Âèñ„Çä„Åì„Åº„ÅôÂØæÁ≠ñÔºâ
// document.addEventListener('visibilitychange', () => {
//   if (document.visibilityState === 'visible') {
//     closeLoadingOverlay();
//     enableStart();
//   }
// });


// ‚úÖ Â∫ÉÂëäË¶ñËÅ¥„Ç§„Éô„É≥„ÉàÂèó‰ø°ÊôÇ„ÅÆÂá¶ÁêÜÔºàReactNativeWebView„Åã„Çâ„ÅÆ„Ç§„Éô„É≥„ÉàÔºâ
// window.addEventListener("AD_WATCHED", async (event) => {
//   const adType = event.detail?.type || "unknown";
//   const user_id = sessionStorage.getItem("user_id");

//   showLoadingOverlay();  // ‚úÖ Â∫ÉÂëäË¶ñËÅ¥ÂÆå‰∫ÜÊôÇ„Å´‰∏ÄÂ∫¶„É≠„Éº„Éá„Ç£„É≥„Ç∞ÔºàÂõûÂæ©ÈÄö‰ø°„ÅÆÈñìÔºâ

//   try {
//     const res = await fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
//       method: "POST",
//       headers: { "Content-Type": "application/json" },
//       body: JSON.stringify({ user_id: user_id, type: adType })
//     });

//     const result = await res.json();
//     console.log("‚úÖ AD_WATCHED result:", result);

//     // ‚úÖ ÊàêÂäü„Åó„Åü„Çâ„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÂ§ñ„Åô
//     hideLoadingOverlay();

//     // ‚úÖ ÂøÖË¶Å„Å´Âøú„Åò„Å¶„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫„Å™„Å©ËøΩÂä†
//     alert("‚úÖ Â∫ÉÂëäË¶ñËÅ¥„ÅåÂÆå‰∫Ü„Åó„ÄÅ„Éó„É¨„Ç§ÂõûÊï∞„ÅåÂõûÂæ©„Åó„Åæ„Åó„ÅüÔºÅ");
//   } catch (err) {
//     console.error("‚ùå AD_WATCHED error:", err);
//     hideLoadingOverlay(); // Âøµ„ÅÆ„Åü„ÇÅ„Ç®„É©„ÉºÊôÇ„ÇÇÈùûË°®Á§∫
//     alert("‚ùå Â∫ÉÂëäË¶ñËÅ¥Âæå„ÅÆÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
//   }
// });



  // window.addEventListener("AD_WATCHED", (event) => {
  //   const adType = event.detail?.type || "unknown";
  //   console.log("‚úÖ AD_WATCHED Âèó‰ø°:", adType);
  //   alert(`(1/5) AD_WATCHED Âèó‰ø°: type=${adType}`);
  //   alert(`(2/5) Èñâ„Åò„ÇãÂâç„ÅÆÂèØË¶ñÁä∂ÊÖã: ${isOverlayVisible()}`);

  //   fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
  //     method: "POST",
  //     headers: { "Content-Type": "application/json" },
  //     body: JSON.stringify({ user_id, type: adType })
  //   })
  //   .then(res => {
  //     if (!res.ok) throw new Error("„É™„Éü„ÉÉ„ÉàËß£Èô§Â§±Êïó");
  //     return res.json();
  //   })
  //   .then(() => {
  //     console.log("‚úÖ „É™„Éü„ÉÉ„ÉàÂõûÂæ©ÊàêÂäü ‚Üí „Ç≤„Éº„É†ÈñãÂßã");
  //     // closeLoadingOverlay();      
  //     // beginGameFlow();            
  //     openLoadingOverlay("‚úÖ ÂõûÂæ©ÂÆå‰∫ÜÔºÅ„Ç≤„Éº„É†ÈñãÂßã‚Ä¶");
  //     setTimeout(() => {
  //       closeLoadingOverlay();    // ‚ú® ÊºîÂá∫„Åó„Å§„Å§Á¢∫ÂÆü„Å´Ëß£Èô§
  //       // beginGameFlow();          // ‚ñ∂ „Çπ„Çø„Éº„Éà
  //     }, 300);
  //   })
  //   .catch(err => {
  //     console.error("Â∫ÉÂëäËß£Èô§„Ç®„É©„Éº:", err);
  //     closeLoadingOverlay();      // ‚úÖ Âøµ„ÅÆ„Åü„ÇÅ„Åì„Åì„Åß„ÇÇËß£Èô§
  //   });
  // });

  function isOverlayVisible() {
    const el = document.getElementById("loading-overlay");
    if (!el) return false;
    const cs = getComputedStyle(el);
    return cs.display !== "none" && !el.classList.contains("hidden");
  }

  // ‚òÖ AD_WATCHED: Â†±ÈÖ¨Áç≤Âæó ‚Üí ÂõûÂæ©API ‚Üí „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈñâ„Åò„Çã
  window.addEventListener("AD_WATCHED", (event) => {
        // alert("üéâ AD_WATCHED „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü");
        const adType = event.detail?.type || "unknown";
        alert("AD1: " + adType); // ‚Üê „Åì„Çå„ÅßÂÆüÈöõ„ÅÆ adType „ÅÆ‰∏≠Ë∫´„ÅåË¶ã„Åà„Çã

        fetch("https://bearhug-6c58c8d5bd0e.herokuapp.com/adresets/limit/recover", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, type: adType }) // ‚úÖ ‰øÆÊ≠£
      })
      .finally(() => {
        alert("AD2",adType)
        loadingOverlay.classList.add("hidden");
        loadingOverlay.style.display = "none";
        // startGame();
      })
        closeLoadingOverlay();
        // showPopup(`‚úÖ ${adType === 'chat' ? '„ÉÅ„É£„ÉÉ„Éà' : '„Éû„ÉÉ„ÉÅ'}ÂõûÊï∞„ÅåÂõûÂæ©„Åó„Åæ„Åó„ÅüÔºÅ`);
    });
  

  window.addEventListener("AD_CLOSED", (event) => {
    console.log("[WEB] AD_CLOSED", event?.detail);
    closeLoadingOverlay();
    // ÂøÖË¶Å„Å™„Çâ„Åì„Åì„Åß beginGameFlow() „ÇíÂëº„Å∂
    // beginGameFlow();
  });

// ‚úÖ Â∫ÉÂëäÂ§±Êïó„Ç§„Éô„É≥„ÉàÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
  window.addEventListener("AD_FAILED", (event) => {
        alert(`(F1) AD_FAILED Âèó‰ø°: ${msg} ‚Üí „É≠„Éº„Éá„Ç£„É≥„Ç∞Èñâ„Åò„Åæ„Åô`);
        const msg = event.detail?.message || "‰∏çÊòé„Å™„Ç®„É©„Éº";
        closeLoadingOverlay();
        try { closeLoadingOverlay && closeLoadingOverlay(); } catch (e) {}
        alert(`(F2) Èñâ„ÅòÂæå„ÅÆÂèØË¶ñÁä∂ÊÖã: ${isOverlayVisible()}`);
      }, { passive: true });
        // showPopup(`‚ùå Â∫ÉÂëä„ÅÆË¶ñËÅ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${msg}`);

  // === Debug alert bridge: Web ‚Üí React Native (Android„Åßalert„ÅåÂá∫„Å™„ÅÑÂØæÁ≠ñ) ===
(function () {
  if (window.__DEBUG_ALERT_BRIDGE__) return;
  window.__DEBUG_ALERT_BRIDGE__ = true;

  function debugAlert(msg) {
    try {
      // React Native WebView „Å™„Çâ RN ÂÅ¥„Å∏ postMessage
      if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(
          JSON.stringify({ __debugAlert: true, msg: String(msg) })
        );
      } else {
        // „Éñ„É©„Ç¶„Ç∂(PC)Á≠â„Åß„ÅØÈÄöÂ∏∏„ÅÆ alert
        window.alert(String(msg));
      }
    } catch (e) {
      try { window.alert(String(msg)); } catch {}
      console.error("debugAlert error:", e);
    }
  }

  // Êó¢Â≠ò„Ç≥„Éº„Éâ„ÅÆ alert() „Çí„Åù„ÅÆ„Åæ„ÅæÁîü„Åã„Åô„Åü„ÇÅ„ÄÅalert „ÇíÂ∑Æ„ÅóÊõø„ÅàÔºàËøΩË®ò„ÅÆ„ÅøÔºâ
  window.alert = debugAlert;
})();



  // ÂàùÊúüÁä∂ÊÖã„Åß„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´„Åó„Å¶„Åä„Åè
  closeLoadingOverlay();
  enableStart();
});